<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GradePro Cloud</title>
    
    <!-- Google Fonts: Prompt & Sarabun (Mixed) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Sarabun', 'sans-serif'], 
                        display: ['Prompt', 'sans-serif'] 
                    },
                    colors: { 
                        // Vibrant Pastel Theme
                        primary: { 50:'#f0f9ff', 100:'#e0f2fe', 200:'#bae6fd', 300:'#7dd3fc', 400:'#38bdf8', 500:'#0ea5e9', 600:'#0284c7', 700:'#0369a1', 800:'#075985', 900:'#0c4a6e' },
                        secondary: { 50:'#fdf4ff', 100:'#fae8ff', 500:'#d946ef' },
                        success: { 50:'#f0fdf4', 500:'#22c55e' },
                        warning: { 50:'#fffbeb', 500:'#f59e0b' },
                        danger: { 50:'#fef2f2', 500:'#ef4444' }
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * { font-family: 'Sarabun', sans-serif; }
        h1, h2, h3, h4, h5, h6, .font-display, button, .tab-btn, th, .header-text { font-family: 'Prompt', sans-serif !important; }
        
        body { 
            background-color: #f8fafc;
            /* Subtle modern gradient background */
            background-image: radial-gradient(at 40% 20%, hsla(28,100%,74%,0.1) 0px, transparent 50%),
                              radial-gradient(at 80% 0%, hsla(189,100%,56%,0.1) 0px, transparent 50%),
                              radial-gradient(at 0% 50%, hsla(340,100%,76%,0.1) 0px, transparent 50%);
            color: #334155; 
        }
        
        .glass-card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); 
        }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        #error-display { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; padding: 20px; color: red; overflow: auto; }
        
        /* Sticky Headers */
        .sticky-left-0 { position: sticky; left: 0; z-index: 20; border-right: 1px solid #e2e8f0; }
        .sticky-left-1 { position: sticky; left: 48px; z-index: 20; border-right: 1px solid #e2e8f0; }
        .sticky-left-2 { position: sticky; left: 128px; z-index: 20; border-right: 1px solid #e2e8f0; box-shadow: 4px 0 6px -2px rgba(0,0,0,0.05); }
        .sticky-header { position: sticky; top: 0; z-index: 30; }
        
        /* Vertical Text */
        .vertical-header { 
            writing-mode: vertical-rl; 
            transform: rotate(180deg); 
            white-space: nowrap; 
            text-align: left;
            max-height: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #reader video, #scanner-video video, #mobile-reader video { object-fit: cover; border-radius: 1rem; }

        /* --- PRINT STYLES --- */
        .print-only { display: none; }
        
        @media print {
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print, nav, button, input:not([type="text"]), select, .fixed, .shadow-sm, .glass-card, .screen-only { display: none !important; }
            #root { width: 100%; margin: 0; padding: 0; }
            .max-w-7xl, .max-w-xl, .max-w-4xl { max-width: none !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .overflow-auto, .overflow-hidden, .overflow-x-auto { overflow: visible !important; height: auto !important; max-height: none !important; }
            .sticky-header, .sticky-left-0, .sticky-left-1, .sticky-left-2 { position: static !important; border: none !important; box-shadow: none !important; }
            
            .print-only { display: block !important; width: 100%; }

            /* Student Report (Portrait) */
            @page { size: A4 portrait; margin: 15mm; }
            
            /* Teacher Report (Landscape 2-Column) */
            .teacher-print-wrapper { column-count: 2; column-gap: 10mm; width: 100%; }
            .teacher-print-mode @page { size: A4 landscape; margin: 10mm; }
            
            /* Common Table */
            table.print-table { width: 100% !important; border-collapse: collapse; border: 1px solid #000; font-size: 10pt; page-break-inside: auto; }
            table.print-table th, table.print-table td { border: 1px solid #000 !important; padding: 4px !important; text-align: center; color: #000 !important; background-color: transparent !important; }
            table.print-table th { background-color: #f0f0f0 !important; font-weight: bold; }
            table.print-table td.text-left { text-align: left !important; padding-left: 5px !important; }
            tr { break-inside: avoid; page-break-inside: avoid; }

            /* Header/Footer */
            .print-header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; }
            .print-header h1 { font-size: 16pt; font-weight: bold; margin: 0; font-family: 'Sarabun', sans-serif !important; }
            .print-header p { font-size: 12pt; margin: 0; }
            
            .print-footer { margin-top: 20px; display: flex; justify-content: space-between; page-break-inside: avoid; font-size: 10pt; }
            .signature-block { text-align: center; width: 30%; }
            .signature-line { border-bottom: 1px dotted #000; margin: 25px auto 5px; width: 90%; }

            /* Student Info */
            .student-info-box { border: 1px solid #000; padding: 10px; margin-bottom: 15px; border-radius: 4px; }
            .student-info div { display: flex; justify-content: space-between; margin-bottom: 5px; }
            
            /* Vertical Header Print */
            .vertical-header-print { writing-mode: vertical-rl; transform: rotate(180deg); height: 80px; white-space: nowrap; margin: 0 auto; text-align: left; font-size: 9pt; }
        }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const el = document.getElementById('error-display');
            if(message.includes("permission-denied")) return; 
            if(message.includes("Script error")) {
                 console.warn("Cross-origin script error ignored.");
                 return;
            }
            el.style.display = 'block';
            el.innerHTML = `<h3>⚠️ Application Error</h3><p>${message}</p>`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAT_suSpvRBboyuf7cFaqlCidllBsJqYM0",
            authDomain: "studentgradesystem-2a33f.firebaseapp.com",
            projectId: "studentgradesystem-2a33f",
            storageBucket: "studentgradesystem-2a33f.firebasestorage.app",
            messagingSenderId: "339470940730",
            appId: "1:339470940730:web:cc60c26a4c209caa6d1303",
            measurementId: "G-7MZ12J60VQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'grade-pro-v3'; 
        const useLocalStorage = false;
        
        const LOCAL_KEY = 'gradepro_local_data';
        const loadLocalData = () => JSON.parse(localStorage.getItem(LOCAL_KEY) || '{"students":[], "sections":[]}');
        const saveLocalData = (data) => localStorage.setItem(LOCAL_KEY, JSON.stringify(data));

        // --- ICONS ---
        const Icon = ({ p, size=18, className="", onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{cursor: onClick ? 'pointer' : 'inherit'}}>{p}</svg>
        );
        const Icons = {
            Cloud: (p) => <Icon {...p} p={<><path d="M17.5 19c0-1.7-1.3-3-3-3h-11a4 4 0 0 1-0-8h1a5 5 0 0 1 9.9-1 3 3 0 0 1 3.1 3"/></>} />,
            Search: (p) => <Icon {...p} p={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            User: (p) => <Icon {...p} p={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Lock: (p) => <Icon {...p} p={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            LogOut: (p) => <Icon {...p} p={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Edit: (p) => <Icon {...p} p={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />,
            Trash: (p) => <Icon {...p} p={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Plus: (p) => <Icon {...p} p={<><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>} />,
            Camera: (p) => <Icon {...p} p={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Settings: (p) => <Icon {...p} p={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            AlertTriangle: (p) => <Icon {...p} p={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />,
            FolderPlus: (p) => <Icon {...p} p={<><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><line x1="12" x2="12" y1="10" y2="16"/><line x1="9" x2="15" y1="13" y2="13"/></>} />,
            Upload: (p) => <Icon {...p} p={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />,
            Download: (p) => <Icon {...p} p={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            Database: (p) => <Icon {...p} p={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />,
            ArrowUp: (p) => <Icon {...p} p={<><line x1="12" x2="12" y1="19" y2="5"/><polyline points="5 12 12 5 19 12"/></>} />,
            Users: (p) => <Icon {...p} p={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            UserPlus: (p) => <Icon {...p} p={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></>} />,
            ChevronDown: (p) => <Icon {...p} p={<><polyline points="6 9 12 15 18 9"/></>} />,
            X: (p) => <Icon {...p} p={<><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></>} />,
            FileSpreadsheet: (p) => <Icon {...p} p={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></>} />,
            Filter: (p) => <Icon {...p} p={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            Save: (p) => <Icon {...p} p={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            ChevronRight: (p) => <Icon {...p} p={<><polyline points="9 18 15 12 9 6"/></>} />,
            ChevronLeft: (p) => <Icon {...p} p={<><polyline points="15 18 9 12 15 6"/></>} />,
            QrCode: (p) => <Icon {...p} p={<><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>} />,
            Minus: (p) => <Icon {...p} p={<><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Print: (p) => <Icon {...p} p={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />,
            Backspace: (p) => <Icon {...p} p={<><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></>} />,
            Keyboard: (p) => <Icon {...p} p={<><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.001"/><path d="M10 8h.001"/><path d="M14 8h.001"/><path d="M18 8h.001"/><path d="M6 12h.001"/><path d="M10 12h.001"/><path d="M14 12h.001"/><path d="M18 12h.001"/><path d="M7 16h10"/></>} />,
            Calculator: (p) => <Icon {...p} p={<><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />,
            Link: (p) => <Icon {...p} p={<><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>} />,
            ExternalLink: (p) => <Icon {...p} p={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>} />
        };

        const SEED_SECTIONS = [
            { 
                id: 'sec1', title: 'บทที่ 1: สารพันธุกรรม', color: 'primary', 
                groups: [
                    { 
                        id: 'g1', title: 'คะแนนเก็บ (20)', 
                        columns: [
                           { id: 'c1', name: 'สมุด', max: 10, type: 'manual', link: '' },
                           { id: 'c2', name: 'ใบงาน', max: 10, type: 'manual', link: '' }
                        ]
                    }
                ]
            }
        ];
        const SEED_DATA = [{ id: '66001', no: '1', name: 'นายสมชาย เรียนดี', room: '1/1', scores: { 'c1': 9, 'c2': 8 } }];

        // --- THEME PALETTES (Pastel) ---
        const SECTION_THEMES = [
            { name: 'Sky', bg: 'bg-primary-50', border: 'border-primary-100', text: 'text-primary-700', header: 'bg-primary-100', icon: 'text-primary-400', subHeader: 'text-primary-600', button: 'bg-primary-400 text-white' },
            { name: 'Rose', bg: 'bg-pastelPink-100', border: 'border-pastelPink-100', text: 'text-rose-700', header: 'bg-pastelPink-100', icon: 'text-rose-400', subHeader: 'text-rose-600', button: 'bg-rose-400 text-white' },
            { name: 'Purple', bg: 'bg-pastelPurple-100', border: 'border-pastelPurple-100', text: 'text-purple-700', header: 'bg-pastelPurple-100', icon: 'text-purple-400', subHeader: 'text-purple-600', button: 'bg-purple-400 text-white' },
            { name: 'Emerald', bg: 'bg-pastelGreen-100', border: 'border-pastelGreen-100', text: 'text-emerald-700', header: 'bg-pastelGreen-100', icon: 'text-emerald-400', subHeader: 'text-emerald-600', button: 'bg-emerald-400 text-white' },
            { name: 'Orange', bg: 'bg-pastelOrange-100', border: 'border-pastelOrange-100', text: 'text-orange-700', header: 'bg-pastelOrange-100', icon: 'text-orange-400', subHeader: 'text-orange-600', button: 'bg-orange-400 text-white' },
        ];

        const { useState, useEffect, useMemo, useRef } = React;

        // --- SUB-COMPONENTS ---
        function ScannerController({ isOpen, onScan }) {
            useEffect(() => {
                if(!isOpen) return;
                const scanner = new Html5Qrcode("scanner-video");
                const startScanner = async () => {
                    try {
                        await scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                            (text) => {
                                // No Beep
                                onScan(text.trim());
                            }, 
                            () => {}
                        );
                    } catch(e) { console.error(e); }
                };
                startScanner();
                return () => { try { scanner.stop(); } catch(e){} };
            }, [isOpen]);
            return <div id="scanner-video" className="w-full h-full bg-black rounded-lg overflow-hidden"></div>;
        }

        // Mobile Pair Modal (PC) - QR Generator
        function MobilePairModal({ sessionId, onClose }) {
            const qrRef = useRef(null);
            const [status, setStatus] = useState('กำลังรอการเชื่อมต่อ...');

            useEffect(() => {
                if (qrRef.current) {
                    const url = window.location.href.split('?')[0] + '?scan_session=' + sessionId;
                    qrRef.current.innerHTML = "";
                    new QRCode(qrRef.current, {
                        text: url,
                        width: 200,
                        height: 200,
                        colorDark : "#ec4899", // Pastel Pink QR
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
                
                // Poll for updates (Simulated socket)
                const checkStatus = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'scanner_sessions', sessionId), (docSnap) => {
                    if (docSnap.exists() && docSnap.data().lastScanned) {
                        setStatus(`ได้รับข้อมูล: ${docSnap.data().lastScanned}`);
                        // Play Beep on PC when data received
                        const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                        audio.volume = 0.5;
                        audio.play().catch(()=>{});
                    }
                });
                return () => checkStatus();
            }, [sessionId]);

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 animate-fade-in">
                    <div className="bg-white rounded-3xl p-8 text-center max-w-sm w-full relative shadow-2xl">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full p-2 hover:bg-gray-200 transition"><Icons.X size={20}/></button>
                        <div className="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 text-primary-600"><Icons.QrCode size={32}/></div>
                        <h3 className="text-2xl font-bold text-gray-800 mb-2 font-display">Mobile Pair</h3>
                        <p className="text-gray-500 mb-6 text-sm">ใช้มือถือสแกน QR Code นี้<br/>เพื่อเปลี่ยนมือถือเป็นเครื่องยิงบาร์โค้ด</p>
                        
                        <div ref={qrRef} className="bg-white p-4 rounded-xl border-2 border-dashed border-primary-200 inline-block mb-4 shadow-sm"></div>
                        
                        <div className="text-xs text-gray-400 font-mono bg-gray-50 p-2 rounded border border-gray-100 mb-4 break-all">ID: {sessionId}</div>
                        
                        <div className={`px-4 py-2 rounded-full font-mono text-sm font-bold transition-all ${status.includes('ได้รับ') ? 'bg-green-100 text-green-700 scale-105' : 'bg-gray-100 text-gray-400'}`}>
                            {status}
                        </div>
                    </div>
                </div>
            );
        }

        // Mobile Scanner View (Phone) - Camera
        function MobileScannerView({ sessionId, onClose }) {
            const [status, setStatus] = useState('แตะปุ่มเพื่อเริ่มสแกน');
            const [lastScanned, setLastScanned] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (!isScanning) return;

                const timer = setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("mobile-reader");
                    scannerRef.current = html5QrCode;

                    html5QrCode.start(
                        { facingMode: "environment" }, 
                        { fps: 10, qrbox: 250 },
                        (text) => {
                            if (text.includes("scan_session")) return; 
                            if (lastScanned === text) return;
                            
                            setLastScanned(text);
                            setStatus(`กำลังส่ง: ${text}`);

                            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                            audio.volume = 0.5;
                            audio.play().catch(e => console.log('Audio play failed', e));

                            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scanner_sessions', sessionId), { 
                                lastScanned: text, 
                                timestamp: Date.now() 
                            }, { merge: true })
                            .then(() => setStatus(`ส่งสำเร็จ: ${text}`))
                            .catch(err => setStatus(`ส่งไม่ผ่าน: ${err.message}`));

                            if(navigator.vibrate) navigator.vibrate(200);
                            
                            setTimeout(() => { 
                                setLastScanned(null); 
                                setStatus("พร้อมสแกน..."); 
                            }, 2000);
                        },
                        (errorMessage) => {
                            // parse error, ignore
                        }
                    ).catch(err => {
                        setStatus("ไม่สามารถเปิดกล้องได้: " + err);
                        setIsScanning(false);
                    });
                }, 100);

                return () => {
                    clearTimeout(timer);
                    if (scannerRef.current) {
                        scannerRef.current.stop().catch(err => console.error(err));
                    }
                };
            }, [isScanning, sessionId]);

            return (
                <div className="fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center p-4">
                    <h3 className="text-white text-xl font-bold mb-4 font-display flex items-center gap-2">
                        <Icons.Camera/> Mobile Scanner
                    </h3>
                    
                    {isScanning ? (
                        <div id="mobile-reader" className="bg-white rounded-xl overflow-hidden w-full max-w-sm border-4 border-indigo-300 shadow-2xl h-80"></div>
                    ) : (
                        <div className="text-center w-full max-w-sm">
                             <div className="w-full h-64 bg-gray-800 rounded-xl flex items-center justify-center mb-6 border-2 border-dashed border-gray-600">
                                <span className="text-gray-400">กล้องปิดอยู่</span>
                             </div>
                             <button onClick={() => setIsScanning(true)} className="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-full font-bold shadow-lg text-lg w-full animate-bounce">
                                แตะเพื่อเริ่มสแกน
                             </button>
                        </div>
                    )}
                    
                    <div className="mt-6 flex flex-col items-center gap-2 w-full max-w-sm">
                        <div className={`px-4 py-3 rounded-xl font-mono text-sm font-bold text-center w-full transition-all ${status.includes('สำเร็จ') ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-800'}`}>
                            {status}
                        </div>
                        <button onClick={onClose} className="mt-4 bg-red-600 hover:bg-red-700 text-white px-8 py-2 rounded-full font-bold shadow-lg w-full">
                            ปิดการทำงาน
                        </button>
                    </div>
                </div>
            );
        }

        // Virtual Numpad Component (Draggable)
        function VirtualNumpad({ isOpen, target, onInput, onClose, onConfirm }) {
            if (!isOpen || !target) return null;
            
            const keys = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '0', 'Del'];
            
            // Dragging Logic
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const dragStart = useRef({ x: 0, y: 0 });

            const handleStart = (clientX, clientY) => {
                setIsDragging(true);
                dragStart.current = { x: clientX - position.x, y: clientY - position.y };
            };

            const handleMouseDown = (e) => handleStart(e.clientX, e.clientY);
            const handleTouchStart = (e) => handleStart(e.touches[0].clientX, e.touches[0].clientY);

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    setPosition({ x: e.clientX - dragStart.current.x, y: e.clientY - dragStart.current.y });
                };
                const handleTouchMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault(); // Prevent scrolling while dragging
                    setPosition({ x: e.touches[0].clientX - dragStart.current.x, y: e.touches[0].clientY - dragStart.current.y });
                };
                const handleUp = () => setIsDragging(false);

                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleUp);
                    window.addEventListener('touchmove', handleTouchMove, { passive: false });
                    window.addEventListener('touchend', handleUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleUp);
                    window.removeEventListener('touchmove', handleTouchMove);
                    window.removeEventListener('touchend', handleUp);
                };
            }, [isDragging]);
            
            return (
                <div className="fixed top-28 right-4 z-[70] pointer-events-none">
                    <div 
                        className="bg-white p-3 rounded-2xl shadow-xl border border-gray-200 pointer-events-auto w-60 ring-1 ring-black/5 animate-fade-in"
                        style={{ transform: `translate(${position.x}px, ${position.y}px)`, transition: isDragging ? 'none' : 'transform 0.1s' }}
                    >
                        <div 
                            className="flex justify-between items-center mb-2 border-b pb-2 cursor-move bg-slate-50 -m-3 mb-2 p-3 rounded-t-2xl select-none"
                            onMouseDown={handleMouseDown}
                            onTouchStart={handleTouchStart}
                            title="กดค้างเพื่อลากย้าย"
                        >
                            <div className="overflow-hidden">
                                <div className="text-[9px] text-gray-400 uppercase font-bold tracking-wide flex items-center gap-1"><Icons.FileSpreadsheet size={10}/> Drag</div>
                                <div className="text-sm font-bold text-slate-700 flex items-center gap-2 truncate">
                                    {target.name}
                                </div>
                            </div>
                            <button onClick={onClose} className="bg-white p-1 rounded-full text-gray-400 hover:bg-rose-100 hover:text-rose-500 transition shadow-sm pointer-events-auto"><Icons.X size={16}/></button>
                        </div>
                        <div className="grid grid-cols-3 gap-2 mb-2">
                            {keys.map(k => (
                                <button key={k} 
                                    onClick={() => onInput(k)}
                                    className={`h-10 rounded-lg text-lg font-bold shadow-sm active:scale-95 transition-transform duration-100 flex items-center justify-center ${k === 'Del' ? 'bg-red-50 text-red-500 hover:bg-red-100' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}
                                >
                                    {k === 'Del' ? <Icons.Backspace size={20}/> : k}
                                </button>
                            ))}
                        </div>
                        <button onClick={onConfirm} className="w-full bg-gradient-to-r from-primary-500 to-primary-600 text-white py-2 rounded-xl font-bold text-base shadow-md active:scale-95 transition flex items-center justify-center gap-2">
                            <Icons.Save size={18}/> บันทึก
                        </button>
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('student');
            const [students, setStudents] = useState([]);
            const [sections, setSections] = useState([]);
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(null);
            
            // UI States
            const [searchId, setSearchId] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [password, setPassword] = useState('');
            const [teacherTab, setTeacherTab] = useState('scores'); 
            const [selectedRoom, setSelectedRoom] = useState('All');
            const [teacherSearchId, setTeacherSearchId] = useState('');
            const [sortConfig, setSortConfig] = useState({key: 'no', direction: 'asc'});
            const [warning, setWarning] = useState({ show: false, msg: '' });
            
            // Collapsible Logic
            const [collapsedSections, setCollapsedSections] = useState({}); 

            // Modals & Scanner
            const [scoreModalData, setScoreModalData] = useState(null); 
            const [studentModalData, setStudentModalData] = useState(null);
            const [isAddStudentOpen, setIsAddStudentOpen] = useState(false);
            const [isImportOpen, setIsImportOpen] = useState(false);
            const [importText, setImportText] = useState('');
            const [isScannerOpen, setIsScannerOpen] = useState(false);
            const [scanTarget, setScanTarget] = useState('');
            const [returnToScanner, setReturnToScanner] = useState(false); 
            
            // Mobile Pair - Auto Check URL
            const [isMobilePairOpen, setIsMobilePairOpen] = useState(false);
            const [scannerSessionId, setScannerSessionId] = useState(null);
            const [isMobileScannerActive, setIsMobileScannerActive] = useState(false);
            
            // Numpad State
            const [numpadState, setNumpadState] = useState({ isOpen: false, colId: null, max: 0, name: '' });
            const [useNumpad, setUseNumpad] = useState(false); // Default to FALSE (Keyboard Mode)

            // Settings Modals & Data Actions
            const [isSectionSettingsOpen, setIsSectionSettingsOpen] = useState(false);
            const [sectionSettings, setSectionSettings] = useState({});
            const [isGroupModalOpen, setIsGroupModalOpen] = useState(false);
            const [groupModalData, setGroupModalData] = useState({});
            const [isColumnModalOpen, setIsColumnModalOpen] = useState(false);
            const [columnModalData, setColumnModalData] = useState({});
            
            // Admin Action States
            const [isPasswordConfirmOpen, setIsPasswordConfirmOpen] = useState(false);
            const [pendingAction, setPendingAction] = useState(null); // { type: 'export'|'import'|'clear'|'export_excel' }
            const [confirmPasswordInput, setConfirmPasswordInput] = useState('');
            const fileInputRef = useRef(null);

            // Import Progress
            const [importProgress, setImportProgress] = useState(0);
            const [isImporting, setIsImporting] = useState(false);

            // New Student State
            const [newStudent, setNewStudent] = useState({ id: '', no: '', name: '', room: '' });

            // Refs for Auto Focus
            const studentInputRef = useRef(null);
            const teacherInputRef = useRef(null);

            // --- AUTH & DATA & MOBILE CHECK ---
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const scanSession = params.get('scan_session');
                if (scanSession) {
                    setIsMobileScannerActive(true);
                    setScannerSessionId(scanSession); 
                }

                if(useLocalStorage) {
                    setUser({uid: 'offline'});
                    const d = loadLocalData();
                    if(!d.sections.length) { d.sections = SEED_SECTIONS; d.students = SEED_DATA; saveLocalData(d); }
                    setSections(d.sections); setStudents(d.students); setLoading(false);
                } else {
                    const initAuth = async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    };
                    initAuth();
                    return onAuthStateChanged(auth, setUser);
                }
            }, []);

            useEffect(() => {
                if(!user || useLocalStorage) return;
                const unsub1 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main'), d => d.exists() && setSections(d.data().sections || []));
                const unsub2 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), s => {
                    setStudents(s.docs.map(d => ({id: d.id, ...d.data()})));
                    setLoading(false);
                });
                return () => { unsub1(); unsub2(); };
            }, [user]);

            // Scanner Listener (PC listening to Mobile)
            useEffect(() => {
                if (!scannerSessionId || isMobileScannerActive) return; 
                const sessionDoc = doc(db, 'artifacts', appId, 'public', 'data', 'scanner_sessions', scannerSessionId);
                const unsub = onSnapshot(sessionDoc, (doc) => {
                    const data = doc.data();
                    if (data && data.lastScanned) {
                        handleTeacherSearch(data.lastScanned.trim());
                    }
                });
                return () => unsub();
            }, [scannerSessionId, isMobileScannerActive, students]);

            // --- AUTO FOCUS LOGIC ---
            useEffect(() => {
                const isAnyModalOpen = isScannerOpen || scoreModalData || studentModalData || isAddStudentOpen || isImportOpen || isMobilePairOpen || isSectionSettingsOpen || isGroupModalOpen || isColumnModalOpen || isPasswordConfirmOpen;

                if (!isAnyModalOpen) {
                    if (view === 'student' && studentInputRef.current) {
                        setTimeout(() => studentInputRef.current.focus(), 100);
                    } else if (view === 'teacher' && teacherTab === 'scores' && teacherInputRef.current) {
                        setTimeout(() => teacherInputRef.current.focus(), 100);
                    }
                }
            }, [view, teacherTab, isScannerOpen, scoreModalData, studentModalData, isAddStudentOpen, isImportOpen, isMobilePairOpen, isSectionSettingsOpen, isGroupModalOpen, isColumnModalOpen, isPasswordConfirmOpen, loading]);

            // --- LOGIC ---
            const saveData = (newS, newSec) => {
                if(useLocalStorage) {
                    const d = loadLocalData();
                    if(newS) d.students = newS; if(newSec) d.sections = newSec;
                    saveLocalData(d);
                    if(newS) setStudents(newS); if(newSec) setSections(newSec);
                } else {
                    if(newSec) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main'), {sections: newSec}, {merge:true});
                }
            };

            const updateStudent = async (studentData) => {
                Object.keys(studentData).forEach(key => studentData[key] === undefined && delete studentData[key]);
                if(useLocalStorage) {
                    const newS = students.map(s => s.id === studentData.id ? studentData : s);
                    if(!newS.find(s => s.id === studentData.id)) newS.push(studentData);
                    saveData(newS, null);
                } else {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', studentData.id), studentData, {merge:true});
                }
            };

            const handleTeacherSearch = (scannedId) => {
                const id = scannedId || teacherSearchId;
                const s = students.find(x => x.id === id || x.name.includes(id));
                if (s) {
                    if(isScannerOpen) setReturnToScanner(true); 
                    setScoreModalData(JSON.parse(JSON.stringify(s)));
                    setTeacherSearchId('');
                    setIsScannerOpen(false);
                    setIsMobilePairOpen(false);
                    // Play Beep on PC
                    const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                    audio.volume = 0.5;
                    audio.play().catch(()=>{});
                } else {
                    setWarning({show:true, msg:'ไม่พบข้อมูลนักเรียน'});
                }
            };

            const navigateStudent = (direction) => {
                if(!scoreModalData) return;
                const currentIndex = processedStudents.findIndex(s => s.id === scoreModalData.id);
                const nextIndex = currentIndex + direction;
                if(nextIndex >= 0 && nextIndex < processedStudents.length) {
                    updateStudent(scoreModalData); 
                    setScoreModalData(JSON.parse(JSON.stringify(processedStudents[nextIndex])));
                }
            };
            
            const handlePrint = () => {
                window.print();
            };
            
            const handleNumpadInput = (key) => {
                if (!scoreModalData || !numpadState.colId) return;
                
                const colId = numpadState.colId;
                const currentVal = String(scoreModalData.scores?.[colId] || '');
                let newVal = currentVal;

                if (key === 'Del') {
                    newVal = currentVal.slice(0, -1);
                } else {
                    // Prevent multiple dots
                    if (key === '.' && currentVal.includes('.')) return;
                    newVal = currentVal + key;
                }

                // Validate Max
                if (parseFloat(newVal) > numpadState.max) {
                    setWarning({ show: true, msg: `คะแนนห้ามเกิน ${numpadState.max}` });
                    if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    return;
                }

                setScoreModalData({
                    ...scoreModalData,
                    scores: { ...scoreModalData.scores, [colId]: newVal }
                });
            };

            // Admin Actions Handlers
            const requestAdminAction = (type) => {
                setPendingAction(type);
                setConfirmPasswordInput('');
                setIsPasswordConfirmOpen(true);
            };

            const executeAdminAction = () => {
                if (confirmPasswordInput !== '65411597') {
                    alert('รหัสผ่านไม่ถูกต้อง');
                    return;
                }
                setIsPasswordConfirmOpen(false);

                if (pendingAction === 'export') {
                    const dataStr = JSON.stringify({ students, sections });
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', `gradepro_backup_${new Date().toISOString().slice(0,10)}.json`);
                    linkElement.click();
                } else if (pendingAction === 'export_excel') {
                    // Generate CSV for Excel
                    let csvContent = "\uFEFF"; // BOM for Thai support
                    
                    // 1. Headers
                    const headers = ["เลขที่", "รหัส", "ชื่อ-นามสกุล", "ห้อง"];
                    const colIds = [];
                    
                    sections.forEach(sec => {
                        sec.groups.forEach(grp => {
                            grp.columns.forEach(col => {
                                headers.push(`${sec.title}-${col.name} (เต็ม ${col.max})`);
                                colIds.push(col.id);
                            });
                        });
                    });
                    
                    csvContent += headers.join(",") + "\n";
                    
                    // 2. Rows
                    // Sort by room then no
                    const sortedStudents = [...students].sort((a,b) => {
                        if (a.room !== b.room) return a.room.localeCompare(b.room);
                        return (parseInt(a.no)||0) - (parseInt(b.no)||0);
                    });

                    sortedStudents.forEach(s => {
                        const row = [
                            `"${s.no || ''}"`,
                            `"${s.id || ''}"`,
                            `"${s.name || ''}"`,
                            `"${s.room || ''}"`
                        ];
                        
                        colIds.forEach(cid => {
                            let score = s.scores && s.scores[cid] !== undefined ? s.scores[cid] : "";
                            let foundCol = null;
                            let foundGroup = null;
                            for(const sec of sections) {
                                for(const grp of sec.groups) {
                                    const c = grp.columns.find(cl => cl.id === cid);
                                    if(c) { foundCol = c; foundGroup = grp; break; }
                                }
                                if(foundCol) break;
                            }

                            if(foundCol && foundCol.type !== 'manual') {
                                score = calculateColumnValue(s, foundGroup, foundCol);
                                if(score === '-') score = "";
                            }

                            row.push(`"${score}"`);
                        });
                        
                        csvContent += row.join(",") + "\n";
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `gradepro_score_sheet_${new Date().toISOString().slice(0,10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } else if (pendingAction === 'import') {
                    if (fileInputRef.current) fileInputRef.current.click();
                } else if (pendingAction === 'clear') {
                    if(confirm('⚠️ คำเตือน: ข้อมูลนักเรียนและคะแนนทั้งหมดจะถูกลบถาวร ยืนยันหรือไม่?')) {
                        saveData([], []);
                        alert('ล้างข้อมูลเรียบร้อยแล้ว');
                    }
                }
            };

            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        if (Array.isArray(json.students) && Array.isArray(json.sections)) {
                            if(confirm(`ยืนยันการนำเข้าข้อมูล? \n- นักเรียน: ${json.students.length} คน\n- บทเรียน: ${json.sections.length} บท`)) {
                                saveData(json.students, json.sections);
                                alert('นำเข้าข้อมูลสำเร็จ');
                            }
                        } else {
                            alert('รูปแบบไฟล์ไม่ถูกต้อง');
                        }
                    } catch (err) {
                        alert('เกิดข้อผิดพลาดในการอ่านไฟล์');
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            };
            
            const handleBulkImport = async () => {
                if (!importText.trim()) return;
                setIsImporting(true);
                setImportProgress(0);

                const lines = importText.trim().split('\n');
                const newStudents = [];

                for (let line of lines) {
                    const p = line.trim().split(/[\t,]+/);
                    if (p.length >= 2) {
                        const id = p[0].trim();
                        const name = p[1].trim();
                        const room = p[2]?.trim() || '';
                        const no = p[3]?.trim() || '';
                        if(id && name) {
                            newStudents.push({ id, name, room, no, scores: {} });
                        }
                    }
                }

                if (newStudents.length === 0) {
                    alert("ไม่พบข้อมูลที่ถูกต้อง");
                    setIsImporting(false);
                    return;
                }

                if (useLocalStorage) {
                    const existingIds = new Set(students.map(s => s.id));
                    const uniqueNew = newStudents.filter(s => !existingIds.has(s.id));
                    const updatedStudents = [...students, ...uniqueNew];
                    
                    // Simulate progress
                    for(let i=0; i<=100; i+=10) {
                        setImportProgress(i);
                        await new Promise(r => setTimeout(r, 20));
                    }
                    
                    saveData(updatedStudents, null);
                } else {
                    const CHUNK_SIZE = 450; 
                    const chunks = [];
                    for (let i = 0; i < newStudents.length; i += CHUNK_SIZE) {
                        chunks.push(newStudents.slice(i, i + CHUNK_SIZE));
                    }

                    let processedCount = 0;
                    for (let i = 0; i < chunks.length; i++) {
                        const chunk = chunks[i];
                        const batch = writeBatch(db);
                        chunk.forEach(s => {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id);
                            batch.set(docRef, s, { merge: true });
                        });
                        await batch.commit();
                        processedCount += chunk.length;
                        setImportProgress(Math.round((processedCount / newStudents.length) * 100));
                    }
                }

                alert(`นำเข้าสำเร็จ ${newStudents.length} รายการ`);
                setIsImporting(false);
                setImportProgress(0);
                setIsImportOpen(false);
                setImportText('');
            };


            // Structure Management
            const handleSaveSection = () => { if(!sectionSettings.title) return; let newSecs = [...sections]; if(sectionSettings.id) { newSecs = newSecs.map(s => s.id === sectionSettings.id ? {...s, title: sectionSettings.title} : s); } else { newSecs.push({id: `sec_${Date.now()}`, title: sectionSettings.title, color: 'primary', groups: []}); } saveData(null, newSecs); setIsSectionSettingsOpen(false); };
            const handleDeleteSection = (secId) => { if(!confirm('ยืนยันลบ?')) return; saveData(null, sections.filter(s => s.id !== secId)); };
            const handleSaveGroup = () => { if(!groupModalData.title) return; const newSecs = sections.map(s => { if(s.id === groupModalData.sectionId) { const groups = [...(s.groups || [])]; if(groupModalData.id) { const idx = groups.findIndex(g => g.id === groupModalData.id); groups[idx] = {...groups[idx], title: groupModalData.title}; } else { groups.push({id: `g_${Date.now()}`, title: groupModalData.title, columns: []}); } return {...s, groups}; } return s; }); saveData(null, newSecs); setIsGroupModalOpen(false); };
            const handleDeleteGroup = (secId, groupId) => { if(!confirm('ยืนยันลบ?')) return; const newSecs = sections.map(s => s.id === secId ? {...s, groups: s.groups.filter(g => g.id !== groupId)} : s); saveData(null, newSecs); };
            const handleSaveColumn = () => { if(!columnModalData.name) return; const newSecs = sections.map(s => { if(s.id === columnModalData.sectionId) { return {...s, groups: s.groups.map(g => { if(g.id === columnModalData.groupId) { const cols = [...(g.columns || [])]; const newCol = { id: columnModalData.id || `c_${Date.now()}`, name: columnModalData.name, max: parseInt(columnModalData.max) || 10, type: columnModalData.type || 'manual', link: columnModalData.link || '' }; if(columnModalData.id) { const idx = cols.findIndex(c => c.id === columnModalData.id); cols[idx] = newCol; } else { cols.push(newCol); } return {...g, columns: cols}; } return g; })}; } return s; }); saveData(null, newSecs); setIsColumnModalOpen(false); };
            const handleDeleteColumn = (secId, groupId, colId) => { if(!confirm('ยืนยันลบ?')) return; const newSecs = sections.map(s => { if(s.id === secId) { return {...s, groups: s.groups.map(g => g.id === groupId ? {...g, columns: g.columns.filter(c => c.id !== colId)} : g)}; } return s; }); saveData(null, newSecs); };

            // Calculations
            const calculateColumnValue = (student, group, col) => {
                if (!group || !group.columns) return '-';
                if (col.type === 'manual') return student.scores?.[col.id];
                const manualCols = group.columns.filter(c => c.type === 'manual');
                const totalMax = manualCols.reduce((acc, c) => acc + (parseInt(c.max) || 0), 0);
                let currentTotal = 0; let hasScore = false;
                manualCols.forEach(c => { const val = parseFloat(student.scores?.[c.id]); if (!isNaN(val)) { currentTotal += val; hasScore = true; } });
                if (col.type === 'sum') return hasScore ? parseFloat(currentTotal.toFixed(2)) : '-';
                if (col.type === 'percent') { if (!hasScore || totalMax === 0) return '-'; const weight = parseInt(col.max) || 100; return parseFloat(((currentTotal / totalMax) * weight).toFixed(2)); }
                return '-';
            };

            const processedStudents = useMemo(() => {
                let filtered = students;
                if(selectedRoom !== 'All') filtered = filtered.filter(s => s.room === selectedRoom);
                if(teacherSearchId) filtered = filtered.filter(s => s.id.includes(teacherSearchId) || s.name.includes(teacherSearchId));
                return filtered.sort((a,b) => {
                    if(sortConfig.key === 'no') return (parseInt(a.no)||0) - (parseInt(b.no)||0) * (sortConfig.direction==='asc'?1:-1);
                    return a.id.localeCompare(b.id);
                });
            }, [students, selectedRoom, teacherSearchId, sortConfig]);

            const uniqueRooms = useMemo(() => [...new Set(students.map(s => s.room).filter(Boolean))].sort(), [students]);

            const totalScorePreview = useMemo(() => {
                if(!scoreModalData) return 0;
                let total = 0;
                sections.forEach(s => s.groups?.forEach(g => g.columns?.forEach(c => { if(c.type === 'manual') total += parseFloat(scoreModalData.scores?.[c.id] || 0); })));
                return parseFloat(total.toFixed(2));
            }, [scoreModalData]);

            // --- MOBILE PAIR LOGIC ---
            const handleGenerateScanner = () => {
                const newSessionId = Math.random().toString(36).substring(2, 8).toUpperCase();
                setScannerSessionId(newSessionId);
                setIsMobilePairOpen(true);
                // Create session doc
                if(!useLocalStorage) {
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scanner_sessions', newSessionId), { created: Date.now() });
                }
            };

            // --- RENDER ---
            if (loading) return <div className="flex h-screen items-center justify-center font-bold text-primary-600 animate-pulse font-display">กำลังโหลดข้อมูล...</div>;
            // Mobile Scanner View (No Header)
            if (isMobileScannerActive) return <MobileScannerView sessionId={scannerSessionId} onClose={() => { setIsMobileScannerActive(false); window.history.replaceState(null, '', window.location.pathname); }} />;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 pb-20 font-sans">
                    {/* NAVBAR */}
                    <nav className="bg-white border-b px-4 py-3 sticky top-0 z-50 shadow-sm glass-card">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2 font-bold text-xl text-primary-600 font-display">
                                <div className="bg-primary-500 text-white p-1.5 rounded-lg shadow-sm"><Icons.Cloud className="w-5 h-5" /></div>
                                <span className="text-slate-700">GradePro <span className="text-primary-500">Cloud</span> {useLocalStorage ? '(Offline)' : ''}</span>
                            </div>
                            <button onClick={() => setView(view === 'student' ? 'teacher_login' : 'student')} className="text-sm font-bold text-slate-500 hover:text-primary-600 transition bg-slate-100 hover:bg-slate-200 px-4 py-1.5 rounded-full">
                                {view === 'student' ? 'เข้าสู่ระบบครู' : 'หน้าหลักนักเรียน'}
                            </button>
                        </div>
                    </nav>

                    {/* CONTENT */}
                    <div className="max-w-7xl mx-auto p-4 md:p-6">
                        
                        {/* TEACHER PRINT VIEW (Optimized 2-Column Layout) */}
                        {view === 'teacher' && (
                            <div className="print-only">
                                <div className="student-report-header print-header">
                                    <h1>แบบบันทึกผลการเรียน รายวิชาชีววิทยา 2</h1>
                                    <p><strong>โรงเรียนพิษณุโลกพิทยาคม</strong></p>
                                    <p>ภาคเรียนที่ 2 ปีการศึกษา 2568 ระดับชั้น {selectedRoom !== 'All' ? selectedRoom : '....................'}</p>
                                </div>
                                <div className="print-container">
                                    {[0, 1].map(colIndex => {
                                        const half = Math.ceil(processedStudents.length / 2);
                                        const studentsInCol = processedStudents.slice(colIndex * half, (colIndex + 1) * half);
                                        if (studentsInCol.length === 0) return null;
                                        return (
                                            <div className="print-column" key={colIndex}>
                                                <table className="print-table">
                                                    <thead>
                                                        <tr>
                                                            <th className="w-no">เลขที่</th>
                                                            <th className="w-id">รหัส</th>
                                                            <th className="w-name">ชื่อ-นามสกุล</th>
                                                            {sections.map(sec => sec.groups.map(g => g.columns.map(c => <th key={c.id} className="w-score"><div className="vertical-header-print">{c.name}</div><div style={{borderTop:'1px solid #ccc', fontSize:'8pt'}}>({c.max})</div></th>)))}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {studentsInCol.map(s => (
                                                            <tr key={s.id}>
                                                                <td>{s.no}</td><td>{s.id}</td><td className="text-left">{s.name}</td>
                                                                {sections.map(sec => sec.groups.map(g => g.columns.map(c => { const val = calculateColumnValue(s, g, c); return <td key={c.id}>{val && val !== '-' ? val : ''}</td>; })))}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="print-footer">
                                    <div className="signature-block"><div className="signature-line"></div><p>(นายนวรัตน์  เครือก๋า)</p><p>นักศึกษาฝึกวิชาชีพครู</p></div>
                                    <div className="signature-block"><div className="signature-line"></div><p>(นางสาวพรวดี ใจเที่ยงธรรม)</p><p>ครู</p></div>
                                    <div className="signature-block"><div className="signature-line"></div><p>ผู้อำนวยการสถานศึกษา</p><p>(...........................................................)</p></div>
                                </div>
                            </div>
                        )}
                        
                        {/* STUDENT VIEW */}
                        {view === 'student' && (
                            <>
                                <div className="max-w-xl mx-auto mt-8 animate-slide-up screen-only">
                                    <div className="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary-400 to-primary-600"></div>
                                        <div className="flex justify-between items-start mb-6">
                                            <h2 className="text-3xl font-extrabold text-slate-800 font-display text-center flex-1">ตรวจสอบคะแนน</h2>
                                            {searchResult && (<button onClick={handlePrint} className="bg-slate-100 text-slate-600 p-2 rounded-full hover:bg-slate-200 transition" title="พิมพ์ใบรายงานผลการเรียน"><Icons.Print size={20}/></button>)}
                                        </div>
                                        <div className="flex gap-2">
                                            <input ref={studentInputRef} className="w-full p-4 border-2 rounded-2xl text-lg outline-none focus:border-primary-500 transition" placeholder="เลขประจำตัว (เช่น 66001)" value={searchId} onChange={e => setSearchId(e.target.value)} onKeyDown={e => e.key==='Enter' && document.getElementById('search-btn').click()} />
                                            <button id="search-btn" onClick={() => { const s = students.find(x => x.id === searchId); if (s) setSearchResult(s); else setWarning({show:true, msg:'ไม่พบข้อมูล'}); }} className="bg-primary-600 text-white px-6 rounded-2xl font-bold shadow-lg hover:shadow-xl transition transform active:scale-95"><Icons.Search size={24}/></button>
                                        </div>
                                        {searchResult && (
                                            <div className="mt-8 space-y-6 animate-fade-in">
                                                <div className="bg-primary-50 p-4 rounded-xl flex items-center gap-4 border border-primary-100">
                                                    <div className="bg-white p-3 rounded-full shadow-sm"><Icons.User className="text-primary-600"/></div>
                                                    <div><div className="font-bold text-xl text-slate-800">{searchResult.name}</div><div className="text-sm text-slate-500">เลขที่: {searchResult.no} | ห้อง: {searchResult.room}</div></div>
                                                </div>
                                                {sections.map((sec, idx) => {
                                                    const theme = SECTION_THEMES[idx % SECTION_THEMES.length];
                                                    return (
                                                        <div key={sec.id} className="border rounded-xl overflow-hidden shadow-sm">
                                                            <div className={`${theme.header} p-3 font-bold ${theme.text} border-b font-display`}>{sec.title}</div>
                                                            <div className="bg-white p-3 space-y-2">
                                                                {sec.groups?.map(g => g.columns?.map(c => {
                                                                    const val = calculateColumnValue(searchResult, g, c);
                                                                    const isSpecial = c.type === 'sum' || c.type === 'percent';
                                                                    const isMissing = !val || val === '-';
                                                                    return (
                                                                        <div key={c.id} className={`flex justify-between items-center py-2.5 border-b last:border-0 px-3 rounded-lg transition-colors ${isSpecial ? 'bg-slate-100 border-slate-200 shadow-sm' : 'border-gray-100 hover:bg-slate-50'}`}>
                                                                            <span className={`text-sm flex items-center gap-2 ${isSpecial ? 'font-bold text-slate-700' : 'text-gray-600'}`}>
                                                                                {c.name}
                                                                                {isSpecial && <span className="text-[9px] bg-white border border-slate-300 text-slate-500 px-1.5 py-0.5 rounded uppercase tracking-wider">{c.type === 'percent' ? '%' : 'SUM'}</span>}
                                                                            </span>
                                                                            <div className="flex items-center gap-2">
                                                                                {isMissing && c.link && (
                                                                                    <a href={c.link} target="_blank" className="text-xs bg-rose-100 text-rose-600 px-2 py-1 rounded hover:bg-rose-200 font-bold flex items-center gap-1"><Icons.AlertTriangle size={12}/> ตามงาน</a>
                                                                                )}
                                                                                <span className={`font-bold text-base ${isSpecial ? 'text-slate-800' : 'text-slate-600'}`}>{val || '-'} <span className={`${isSpecial ? 'text-slate-400' : 'text-slate-300'} text-xs font-normal ml-1`}>/{c.max}</span></span>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                }))}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {searchResult && (
                                    <div className="print-only">
                                        <div className="student-report-header">
                                            <div style={{marginBottom: '5px'}}><Icons.FileSpreadsheet size={32}/></div>
                                            <h1>รายงานผลการเรียนรายบุคคล</h1>
                                            <h2>รายวิชาชีววิทยา 2</h2>
                                            <h3>ภาคเรียนที่ 2 ปีการศึกษา 2568 | โรงเรียนพิษณุโลกพิทยาคม</h3>
                                        </div>
                                        <div className="student-info">
                                            <div><span><strong>ชื่อ-นามสกุล:</strong> {searchResult.name}</span><span><strong>รหัสประจำตัว:</strong> {searchResult.id}</span></div>
                                            <div><span><strong>ระดับชั้น/ห้อง:</strong> {searchResult.room}</span><span><strong>เลขที่:</strong> {searchResult.no}</span></div>
                                            <div><span><strong>วันที่พิมพ์:</strong> {new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</span></div>
                                        </div>
                                        <table className="print-table">
                                            <thead><tr><th style={{width: '60%'}}>รายการประเมิน / ตัวชี้วัด</th><th style={{width: '20%'}}>คะแนนเต็ม</th><th style={{width: '20%'}}>คะแนนที่ได้</th></tr></thead>
                                            <tbody>
                                                {sections.map(sec => (
                                                    <React.Fragment key={sec.id}>
                                                        <tr style={{backgroundColor: '#f9fafb'}}><td colSpan="3" className="text-left" style={{fontWeight: 'bold', paddingLeft: '10px'}}>{sec.title}</td></tr>
                                                        {sec.groups?.map(g => g.columns?.map(c => {
                                                            const val = calculateColumnValue(searchResult, g, c);
                                                            return <tr key={c.id}><td className="text-left" style={{paddingLeft: '30px'}}>{c.name}</td><td>{c.max}</td><td>{val || '-'}</td></tr>;
                                                        }))}
                                                    </React.Fragment>
                                                ))}
                                                <tr style={{borderTop: '2px solid black'}}><td className="text-right" style={{fontWeight: 'bold', paddingRight: '20px'}}>รวมคะแนนทั้งหมด</td><td></td><td style={{fontWeight: 'bold', fontSize: '14pt'}}>{(() => { let total = 0; sections.forEach(s => s.groups?.forEach(g => g.columns?.forEach(c => { if(c.type === 'manual') total += parseFloat(searchResult.scores?.[c.id] || 0); }))); return parseFloat(total.toFixed(2)); })()}</td></tr>
                                            </tbody>
                                        </table>
                                        <div className="print-footer">
                                            <div className="signature-block"><div className="signature-line"></div><p>({searchResult.name})</p><p>นักเรียนผู้รับรอง</p></div>
                                            <div className="signature-block"><div className="signature-line"></div><p>(นายนวรัตน์ เครือก๋า)</p><p>ครูผู้สอน</p></div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        {/* TEACHER LOGIN */}
                        {view === 'teacher_login' && (
                            <div className="max-w-sm mx-auto mt-16 bg-white p-8 rounded-2xl shadow-xl border animate-slide-up text-center screen-only">
                                <div className="w-16 h-16 bg-primary-50 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Lock className="w-8 h-8 text-primary-600"/></div>
                                <h3 className="text-xl font-bold mb-6 font-display text-slate-800">สำหรับครูผู้สอน</h3>
                                <input type="password" placeholder="รหัสผ่าน" className="w-full p-3 border rounded-xl mb-4 text-center focus:ring-2 focus:ring-primary-500 outline-none" value={password} onChange={e => setPassword(e.target.value)} onKeyDown={e => e.key==='Enter' && document.getElementById('login-btn').click()} />
                                <button id="login-btn" onClick={() => { if(password==='65411597') setView('teacher'); else setWarning({show:true, msg:'รหัสผ่านไม่ถูกต้อง'}); }} className="w-full bg-gradient-to-r from-primary-500 to-primary-600 text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition transform active:scale-95">เข้าสู่ระบบ</button>
                            </div>
                        )}

                        {/* TEACHER DASHBOARD */}
                        {view === 'teacher' && (
                            <div className="animate-fade-in screen-only">
                                {/* TAB NAVIGATION */}
                                <div className="flex space-x-2 bg-white p-1.5 rounded-2xl mb-6 w-fit shadow-sm border border-gray-200 mx-auto md:mx-0">
                                    <button onClick={() => setTeacherTab('scores')} className={`px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 transition ${teacherTab==='scores' ? 'bg-primary-100 text-primary-700 shadow-inner' : 'text-slate-500 hover:bg-slate-50'}`}><Icons.FileSpreadsheet/> บันทึกคะแนน</button>
                                    <button onClick={() => setTeacherTab('students')} className={`px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 transition ${teacherTab==='students' ? 'bg-primary-100 text-primary-700 shadow-inner' : 'text-slate-500 hover:bg-slate-50'}`}><Icons.Users/> รายชื่อนักเรียน</button>
                                    <button onClick={() => setTeacherTab('settings')} className={`px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 transition ${teacherTab==='settings' ? 'bg-slate-100 text-slate-700 shadow-inner' : 'text-slate-500 hover:bg-slate-50'}`}><Icons.Settings/> โครงสร้างวิชา</button>
                                </div>

                                {/* SCORES TAB */}
                                {teacherTab === 'scores' && (
                                    <div className="space-y-4">
                                        <div className="bg-white p-4 rounded-2xl shadow-sm border flex flex-wrap gap-4 items-center justify-between sticky top-20 z-40 glass-card">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-gray-200 shadow-sm">
                                                    <Icons.Filter size={16} className="text-slate-400"/><span className="text-sm font-bold text-slate-600">ห้อง:</span>
                                                    <select className="bg-transparent text-sm font-bold outline-none cursor-pointer text-primary-700" value={selectedRoom} onChange={e => setSelectedRoom(e.target.value)}>
                                                        <option value="All">ทั้งหมด</option>
                                                        {uniqueRooms.map(r => <option key={r} value={r}>{r}</option>)}
                                                    </select>
                                                </div>
                                                <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-gray-200 shadow-sm">
                                                    <Icons.Search size={16} className="text-slate-400"/>
                                                    <input ref={teacherInputRef} className="bg-transparent text-sm outline-none w-32" placeholder="ค้นหา..." value={teacherSearchId} onChange={e => setTeacherSearchId(e.target.value)} onKeyDown={e => e.key==='Enter' && handleTeacherSearch()} />
                                                </div>
                                                <button onClick={() => { setScanTarget('score'); setIsScannerOpen(true); }} className="bg-primary-600 text-white px-4 py-2 rounded-xl font-bold text-sm flex gap-2 hover:shadow-lg transition transform active:scale-95"><Icons.Camera size={18}/> สแกน</button>
                                                <button onClick={handleGenerateScanner} className="bg-white border border-primary-200 text-primary-700 px-4 py-2 rounded-xl font-bold text-sm flex gap-2 hover:bg-primary-50 shadow-sm transition"><Icons.QrCode size={18}/> Mobile Pair</button>
                                                <button onClick={handlePrint} className="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold text-sm flex gap-2 hover:bg-slate-200 shadow-sm transition"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg> Print</button>
                                            </div>
                                            <div className="text-xs text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded border">นักเรียน: {processedStudents.length}</div>
                                        </div>

                                        <div className="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden relative" style={{maxHeight: '75vh', overflow: 'auto'}}>
                                            <table className="w-full text-sm text-left border-collapse">
                                                <thead className="sticky-header shadow-sm bg-slate-50">
                                                    <tr className="bg-white text-slate-700 font-display border-b">
                                                        <th className="p-3 border-r bg-white sticky-left-0 w-12 text-center shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] z-30">#</th>
                                                        <th className="p-3 border-r bg-white sticky-left-1 w-24 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] z-30">รหัส</th>
                                                        <th className="p-3 border-r bg-white sticky-left-2 min-w-[200px] shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] z-30">ชื่อ-สกุล</th>
                                                        {sections.map((sec, idx) => {
                                                            const isCollapsed = collapsedSections[sec.id];
                                                            const colsCount = isCollapsed ? 1 : (sec.groups?.reduce((a, b) => a + (b.columns?.length||0), 0) || 0);
                                                            return colsCount > 0 && (
                                                                <th key={sec.id} colSpan={colsCount} className={`p-2 border-r text-center bg-primary-50 text-primary-700 font-bold border-b border-primary-200 group cursor-pointer hover:bg-primary-100 transition select-none`} onClick={() => setCollapsedSections({...collapsedSections, [sec.id]: !isCollapsed})}>
                                                                    <div className="flex items-center justify-center gap-2">
                                                                        {sec.title}
                                                                        <span className={`transition-transform duration-200 ${isCollapsed ? '-rotate-90' : ''}`}><Icons.ChevronDown size={14}/></span>
                                                                    </div>
                                                                </th>
                                                            );
                                                        })}
                                                        <th className="p-3 text-center w-20 bg-white z-20">แก้ไข</th>
                                                    </tr>
                                                    <tr className="bg-slate-50 text-slate-500 text-xs border-b">
                                                        <th className="p-2 border-r bg-slate-50 sticky-left-0 z-30"></th>
                                                        <th className="p-2 border-r bg-slate-50 sticky-left-1 z-30"></th>
                                                        <th className="p-2 border-r bg-slate-50 sticky-left-2 z-30"></th>
                                                        {sections.map((sec, idx) => {
                                                            if (collapsedSections[sec.id]) {
                                                                return <th key={sec.id} className="p-2 border-r text-center bg-gray-100 text-gray-400 font-normal italic h-40 align-middle">ยุบแล้ว</th>
                                                            }
                                                            return sec.groups?.map(g => g.columns?.map(col => (
                                                                <th key={col.id} className={`p-1 border-r text-center font-normal group relative align-bottom h-48 min-w-[40px] max-w-[50px] ${col.type!=='manual' ? 'bg-slate-100' : 'bg-white hover:bg-slate-50'}`} title={`กลุ่ม: ${g.title}`}>
                                                                     <div className="flex flex-col items-center justify-end h-full pb-1 w-full">
                                                                        <div className="mb-2 font-bold text-xs text-slate-700 vertical-header tracking-wide leading-none">
                                                                            {col.name}
                                                                        </div>
                                                                        <div className={`border rounded px-0.5 w-full text-center text-[10px] font-mono mb-0.5 ${col.type!=='manual' ? 'bg-slate-200 text-slate-600 border-slate-300' : 'bg-white text-slate-500 border-slate-200'}`}>{col.max}</div>
                                                                        {col.type!=='manual' && <div className={`text-[8px] font-bold text-slate-600 uppercase bg-white/50 px-1 rounded`}>{col.type === 'sum' ? 'SUM' : '%'}</div>}
                                                                     </div>
                                                                </th>
                                                            )))
                                                        })}
                                                        <th className="bg-slate-50"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {processedStudents.map((s, sIdx) => (
                                                        <tr key={s.id} className={`border-b hover:bg-primary-50 group transition-colors ${sIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}`}>
                                                            <td className="p-2 text-center border-r bg-inherit sticky-left-0 group-hover:bg-primary-50 z-20 font-mono text-slate-500">{s.no}</td>
                                                            <td className="p-2 font-mono border-r bg-inherit sticky-left-1 group-hover:bg-primary-50 z-20 text-xs font-bold text-slate-500">{s.id}</td>
                                                            <td className="p-2 border-r bg-inherit sticky-left-2 group-hover:bg-primary-50 z-20 font-medium text-slate-700 truncate max-w-[200px]">{s.name}</td>
                                                            {sections.map((sec, idx) => {
                                                                if(collapsedSections[sec.id]) {
                                                                    return <td key={sec.id} className="p-2 border-r text-center text-slate-300 bg-slate-50 group-hover:bg-primary-50"><Icons.Minus size={12} className="mx-auto"/></td>
                                                                }
                                                                return sec.groups?.map(g => g.columns?.map(col => {
                                                                    const val = calculateColumnValue(s, g, col);
                                                                    return (
                                                                        <td key={col.id} className={`p-1 text-center border-r group-hover:bg-primary-50 ${col.type!=='manual'?'bg-slate-100 text-slate-800 font-bold text-xs border-slate-200': 'text-slate-600 font-medium'}`}>
                                                                            {val && val !== '-' ? val : <span className="text-slate-200 font-light">-</span>}
                                                                        </td>
                                                                    );
                                                                }))
                                                            })}
                                                            <td className="p-2 text-center">
                                                                <button onClick={() => setScoreModalData(JSON.parse(JSON.stringify(s)))} className="bg-white border border-primary-200 text-primary-600 p-1.5 rounded-lg hover:bg-primary-600 hover:text-white transition shadow-sm"><Icons.Edit size={16}/></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* STUDENTS TAB */}
                                {teacherTab === 'students' && (
                                    <div className="space-y-4">
                                        <div className="bg-white p-4 rounded-2xl shadow-sm border flex justify-between items-center glass-card">
                                            <h3 className="font-bold flex gap-2 text-gray-700 font-display"><Icons.Users className="text-primary-500"/> จัดการรายชื่อ</h3>
                                            <div className="flex gap-2">
                                                <button onClick={() => setIsAddStudentOpen(true)} className="bg-primary-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow hover:bg-primary-700 flex gap-2 transition active:scale-95"><Icons.Plus/> เพิ่มรายคน</button>
                                                <button onClick={() => setIsImportOpen(true)} className="bg-white border border-gray-200 px-4 py-2 rounded-xl font-bold text-sm text-gray-600 hover:bg-gray-50 flex gap-2 transition"><Icons.Upload/> Import Excel</button>
                                            </div>
                                        </div>
                                        <div className="bg-white rounded-xl shadow border overflow-hidden">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-50 text-gray-700 font-display border-b">
                                                    <tr><th className="p-3 text-center">ที่</th><th className="p-3">รหัส</th><th className="p-3">ชื่อ-นามสกุล</th><th className="p-3 text-center">ห้อง</th><th className="p-3 text-center">จัดการ</th></tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {processedStudents.map(s => (
                                                        <tr key={s.id} className="hover:bg-primary-50 transition-colors">
                                                            <td className="p-3 text-center">{s.no}</td>
                                                            <td className="p-3 font-mono text-gray-500 font-bold">{s.id}</td>
                                                            <td className="p-3 font-bold text-gray-700">{s.name}</td>
                                                            <td className="p-3 text-center"><span className="bg-primary-100 text-primary-700 px-2 py-1 rounded text-xs font-bold">{s.room}</span></td>
                                                            <td className="p-3 text-center flex justify-center gap-2">
                                                                <button onClick={() => setStudentModalData({...s})} className="text-primary-500 hover:bg-primary-100 p-2 rounded transition"><Icons.Edit/></button>
                                                                <button onClick={async () => { if(confirm('ยืนยันลบ?')) {
                                                                    if(useLocalStorage) { saveData(students.filter(x=>x.id!==s.id), null); }
                                                                    else { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id)); }
                                                                }}} className="text-rose-400 hover:bg-rose-100 p-2 rounded transition"><Icons.Trash/></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* SETTINGS TAB (REDESIGNED LIST VIEW) */}
                                {teacherTab === 'settings' && (
                                    <div className="max-w-4xl mx-auto animate-fade-in">
                                        
                                        {/* Data Management Section */}
                                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8">
                                            <div className="p-4 bg-gradient-to-r from-gray-50 to-white border-b flex items-center gap-2">
                                                <div className="bg-primary-100 p-1.5 rounded-lg text-primary-600"><Icons.Database size={20}/></div>
                                                <h3 className="font-bold text-gray-700">จัดการฐานข้อมูล (Data Management)</h3>
                                            </div>
                                            <div className="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                                <button onClick={() => requestAdminAction('export_excel')} className="flex flex-col items-center justify-center p-4 border-2 border-dashed border-green-200 rounded-xl bg-green-50/50 hover:bg-green-50 hover:border-green-400 transition group">
                                                    <div className="mb-2 text-green-600 group-hover:scale-110 transition"><Icons.FileSpreadsheet size={28}/></div>
                                                    <div className="font-bold text-green-800 text-sm">Excel (CSV)</div>
                                                    <div className="text-xs text-green-500 mt-1">ไฟล์ตารางคะแนน</div>
                                                </button>
                                                <button onClick={() => requestAdminAction('export')} className="flex flex-col items-center justify-center p-4 border-2 border-dashed border-primary-200 rounded-xl bg-primary-50/50 hover:bg-primary-50 hover:border-primary-400 transition group">
                                                    <div className="mb-2 text-primary-600 group-hover:scale-110 transition"><Icons.Download size={28}/></div>
                                                    <div className="font-bold text-primary-800 text-sm">Backup (.json)</div>
                                                    <div className="text-xs text-primary-400 mt-1">สำรองข้อมูลระบบ</div>
                                                </button>
                                                <button onClick={() => requestAdminAction('import')} className="flex flex-col items-center justify-center p-4 border-2 border-dashed border-teal-200 rounded-xl bg-teal-50/50 hover:bg-teal-50 hover:border-teal-400 transition group">
                                                    <div className="mb-2 text-teal-600 group-hover:scale-110 transition"><Icons.Upload size={28}/></div>
                                                    <div className="font-bold text-teal-800 text-sm">Restore</div>
                                                    <div className="text-xs text-teal-400 mt-1">กู้คืนจากไฟล์ Backup</div>
                                                </button>
                                                <button onClick={() => requestAdminAction('clear')} className="flex flex-col items-center justify-center p-4 border-2 border-dashed border-red-200 rounded-xl bg-red-50/50 hover:bg-red-50 hover:border-red-400 transition group">
                                                    <div className="mb-2 text-red-500 group-hover:scale-110 transition"><Icons.Trash size={28}/></div>
                                                    <div className="font-bold text-red-700 text-sm">ล้างข้อมูล (Reset)</div>
                                                    <div className="text-xs text-red-400 mt-1">ลบทุกอย่าง</div>
                                                </button>
                                            </div>
                                            <input type="file" ref={fileInputRef} onChange={handleFileImport} className="hidden" accept=".json" />
                                        </div>

                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-xl font-bold text-gray-700 flex items-center gap-2 font-display"><Icons.Settings className="text-slate-500"/> โครงสร้างวิชา</h2>
                                            <button onClick={() => { setSectionSettings({title: '', color: 'primary'}); setIsSectionSettingsOpen(true); }} className="bg-slate-700 text-white px-4 py-2 rounded-xl font-bold shadow hover:bg-slate-800 flex items-center gap-2 transition active:scale-95"><Icons.FolderPlus/> สร้างบทเรียน</button>
                                        </div>

                                        <div className="space-y-6">
                                            {sections.length === 0 && <div className="text-center p-10 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 bg-gray-50">ยังไม่มีบทเรียน เริ่มสร้างเลย!</div>}
                                            {sections.map((sec, idx) => {
                                                const theme = SECTION_THEMES[idx % SECTION_THEMES.length];
                                                return (
                                                <div key={sec.id} className={`rounded-xl overflow-hidden shadow-sm border ${theme.border} bg-white`}>
                                                    {/* Chapter Row */}
                                                    <div className={`${theme.header} p-4 flex justify-between items-center border-b ${theme.border}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center bg-white shadow-sm ${theme.text}`}>
                                                                <span className="font-bold text-lg">{idx + 1}</span>
                                                            </div>
                                                            <h3 className={`font-bold text-lg font-display ${theme.text}`}>{sec.title}</h3>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => { setGroupModalData({title: '', sectionId: sec.id}); setIsGroupModalOpen(true); }} className={`text-xs ${theme.button} px-3 py-1.5 rounded-lg flex items-center gap-1 transition`}><Icons.FolderPlus size={14}/> เพิ่มกลุ่ม</button>
                                                            <button onClick={() => { setSectionSettings({...sec}); setIsSectionSettingsOpen(true); }} className="text-gray-400 hover:text-gray-600 p-1.5"><Icons.Edit size={18}/></button>
                                                            <button onClick={() => handleDeleteSection(sec.id)} className="text-rose-300 hover:text-rose-500 p-1.5"><Icons.Trash size={18}/></button>
                                                        </div>
                                                    </div>

                                                    {/* Groups */}
                                                    <div className="p-4 space-y-4">
                                                        {(!sec.groups || sec.groups.length === 0) && <div className="text-center text-gray-400 text-sm py-2">-- ยังไม่มีกลุ่มคะแนนในบทนี้ --</div>}
                                                        {sec.groups?.map((group, gIdx) => (
                                                            <div key={group.id} className="flex flex-col md:flex-row gap-4 p-4 border border-gray-100 rounded-xl bg-gray-50/50 hover:bg-white hover:shadow-md transition-all duration-300">
                                                                {/* Group Name */}
                                                                <div className="w-full md:w-1/4 border-l-4 border-gray-300 pl-3 py-1">
                                                                    <div className="flex justify-between items-center mb-2">
                                                                         <div className="font-bold text-gray-700 text-sm font-display">{group.title}</div>
                                                                         <button onClick={() => { setColumnModalData({name: '', max: 10, type: 'manual', sectionId: sec.id, groupId: group.id, link: ''}); setIsColumnModalOpen(true); }} className="text-xs bg-primary-100 text-primary-600 px-2 py-1 rounded hover:bg-primary-200 flex items-center gap-1">
                                                                            <Icons.Plus size={12}/> เพิ่มช่อง
                                                                        </button>
                                                                    </div>
                                                                    <div className="text-xs text-gray-400 mt-1 flex gap-2">
                                                                        <button onClick={() => { setGroupModalData({id: group.id, title: group.title, sectionId: sec.id}); setIsGroupModalOpen(true); }} className="hover:text-indigo-500">แก้ไขกลุ่ม</button>
                                                                        <button onClick={() => handleDeleteGroup(sec.id, group.id)} className="hover:text-red-500">ลบกลุ่ม</button>
                                                                    </div>
                                                                </div>

                                                                {/* Columns List */}
                                                                <div className="flex-1 flex flex-wrap gap-2 items-center">
                                                                    {group.columns?.map(col => (
                                                                        <div key={col.id} className="group/col relative bg-white border border-gray-200 rounded-lg px-3 py-2 flex items-center gap-3 hover:border-primary-300 transition cursor-pointer shadow-sm"
                                                                             onClick={() => { setColumnModalData({id: col.id, name: col.name, max: col.max, type: col.type, sectionId: sec.id, groupId: group.id, link: col.link || ''}); setIsColumnModalOpen(true); }}>
                                                                            <div>
                                                                                <div className="text-xs font-bold text-gray-700">{col.name}</div>
                                                                                <div className="text-[10px] text-gray-400">เต็ม {col.max} {col.type!=='manual' && `(${col.type})`}</div>
                                                                            </div>
                                                                            <Icons.Edit size={14} className="text-gray-300 group-hover/col:text-primary-400"/>
                                                                        </div>
                                                                    ))}
                                                                    {(!group.columns || group.columns.length === 0) && <div className="text-xs text-gray-400 italic p-2">ไม่มีช่องคะแนน</div>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );})}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* --- MODALS --- */}

                        {/* MOBILE PAIR MODAL */}
                        {isMobilePairOpen && <MobilePairModal sessionId={scannerSessionId} onClose={() => setIsMobilePairOpen(false)} />}

                        {/* COLUMN MODAL WITH LINK INPUT */}
                        {isColumnModalOpen && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
                                <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-slide-up">
                                    <h3 className="font-bold text-lg mb-4 text-gray-800 font-display">{columnModalData.id ? 'แก้ไขช่องคะแนน' : 'เพิ่มช่องคะแนน'}</h3>
                                    <div className="space-y-4">
                                        <div><label className="text-xs font-bold text-gray-400">ชื่อช่องคะแนน</label><input className="w-full p-3 border-2 border-gray-100 rounded-xl mt-1 focus:border-primary-500 focus:outline-none transition" value={columnModalData.name} onChange={e => setColumnModalData({...columnModalData, name: e.target.value})} autoFocus /></div>
                                        <div><label className="text-xs font-bold text-gray-400">คะแนนเต็ม</label><input type="number" className="w-full p-3 border-2 border-gray-100 rounded-xl mt-1 text-center font-mono focus:border-primary-500 focus:outline-none transition" value={columnModalData.max} onChange={e => setColumnModalData({...columnModalData, max: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-gray-400">ลิงก์งาน (URL) <span className="text-gray-300 font-normal">*สำหรับนักเรียนตามงาน</span></label><input type="text" className="w-full p-3 border-2 border-gray-100 rounded-xl mt-1 text-xs focus:border-primary-500 focus:outline-none transition" placeholder="https://..." value={columnModalData.link || ''} onChange={e => setColumnModalData({...columnModalData, link: e.target.value})} /></div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400">ประเภท</label>
                                            <div className="flex gap-2 mt-1">
                                                {['manual', 'sum', 'percent'].map(t => (
                                                    <button key={t} onClick={() => setColumnModalData({...columnModalData, type: t})} className={`flex-1 py-2 rounded-lg border-2 text-xs font-bold transition ${columnModalData.type === t ? 'bg-primary-50 border-primary-500 text-primary-700' : 'border-gray-100 text-gray-400 hover:border-gray-300'}`}>
                                                        {t === 'manual' ? 'กรอกเอง' : (t === 'sum' ? 'รวม' : '%')}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center mt-8">
                                        {columnModalData.id ? <button onClick={() => { setIsColumnModalOpen(false); handleDeleteColumn(columnModalData.sectionId, columnModalData.groupId, columnModalData.id); }} className="text-rose-400 text-sm hover:text-rose-600 font-bold transition">ลบช่องนี้</button> : <div></div>}
                                        <div className="flex gap-2">
                                            <button onClick={() => setIsColumnModalOpen(false)} className="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-xl font-bold transition">ยกเลิก</button>
                                            <button onClick={handleSaveColumn} className="px-6 py-2 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition transform active:scale-95">บันทึก</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Other Modals (Section, Group, Password, Score, Student, Add, Scanner, Import) - reusing previous code structure, just ensure they are included */}
                        
                        {isSectionSettingsOpen && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
                                <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-slide-up">
                                    <h3 className="font-bold text-lg mb-4 text-gray-800 font-display">{sectionSettings.id ? 'แก้ไขชื่อบทเรียน' : 'สร้างบทเรียนใหม่'}</h3>
                                    <input className="w-full p-3 border-2 border-gray-100 rounded-xl mb-6 focus:border-primary-500 focus:outline-none transition" placeholder="ชื่อบทเรียน (เช่น บทที่ 1)" value={sectionSettings.title} onChange={e => setSectionSettings({...sectionSettings, title: e.target.value})} autoFocus />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setIsSectionSettingsOpen(false)} className="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-xl font-bold transition">ยกเลิก</button>
                                        <button onClick={handleSaveSection} className="px-6 py-2 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition transform active:scale-95">บันทึก</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isGroupModalOpen && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
                                <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-slide-up">
                                    <h3 className="font-bold text-lg mb-4 text-gray-800 font-display">{groupModalData.id ? 'แก้ไขชื่อกลุ่ม' : 'เพิ่มกลุ่มคะแนน'}</h3>
                                    <input className="w-full p-3 border-2 border-gray-100 rounded-xl mb-6 focus:border-primary-500 focus:outline-none transition" placeholder="ชื่อกลุ่ม (เช่น สอบเก็บคะแนน)" value={groupModalData.title} onChange={e => setGroupModalData({...groupModalData, title: e.target.value})} autoFocus />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setIsGroupModalOpen(false)} className="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-xl font-bold transition">ยกเลิก</button>
                                        <button onClick={handleSaveGroup} className="px-6 py-2 bg-primary-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition transform active:scale-95">บันทึก</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isPasswordConfirmOpen && (
                            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                                <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-xs text-center">
                                    <div className="w-14 h-14 bg-warning-100 rounded-full flex items-center justify-center mx-auto mb-4 text-warning-600"><Icons.Lock size={28}/></div>
                                    <h3 className="font-bold text-lg text-gray-800 mb-2">ยืนยันรหัสผ่าน</h3>
                                    <p className="text-sm text-gray-500 mb-4">กรุณากรอกรหัสผ่าน 'admin' เพื่อดำเนินการต่อ</p>
                                    <input 
                                        type="password" 
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl text-center mb-4 focus:border-amber-500 focus:outline-none transition" 
                                        placeholder="รหัสผ่าน" 
                                        value={confirmPasswordInput} 
                                        onChange={e => setConfirmPasswordInput(e.target.value)}
                                        autoFocus
                                        onKeyDown={e => e.key === 'Enter' && executeAdminAction()}
                                    />
                                    <div className="flex gap-2">
                                        <button onClick={() => setIsPasswordConfirmOpen(false)} className="flex-1 py-2.5 rounded-xl text-gray-500 font-bold hover:bg-gray-100 transition">ยกเลิก</button>
                                        <button onClick={executeAdminAction} className="flex-1 py-2.5 rounded-xl bg-amber-500 text-white font-bold hover:bg-amber-600 transition shadow-lg">ยืนยัน</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {scoreModalData && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
                                    <div className="p-5 border-b bg-gray-900 text-white flex justify-between items-center">
                                        <div>
                                            <h3 className="text-xl font-bold font-display">{scoreModalData.name}</h3>
                                            <div className="text-gray-400 text-sm flex gap-3 mt-1">
                                                <span className="bg-gray-700 px-2 rounded text-xs py-0.5">รหัส {scoreModalData.id}</span>
                                                <span className="bg-gray-700 px-2 rounded text-xs py-0.5">ห้อง {scoreModalData.room}</span>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-3xl font-bold text-success-400">{totalScorePreview}</div>
                                            <div className="text-[10px] text-gray-400 uppercase tracking-widest">Total Score</div>
                                        </div>
                                    </div>
                                    <div className="p-6 overflow-y-auto bg-gray-50 flex-1 space-y-6 pb-40"> {/* Add padding bottom for Numpad space */}
                                        <div className="flex justify-between items-center bg-gray-50 p-2 rounded-lg mb-4 border border-gray-200">
                                            <span className="text-sm text-gray-500 font-bold ml-2">โหมดการกรอก:</span>
                                            <button 
                                                onClick={() => setUseNumpad(!useNumpad)}
                                                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-sm transition-all ${useNumpad ? 'bg-primary-600 text-white shadow-md' : 'bg-white text-gray-600 border hover:bg-gray-50'}`}
                                            >
                                                {useNumpad ? <><Icons.Calculator size={18}/> Numpad (แป้นพิมพ์ปิด)</> : <><Icons.Keyboard size={18}/> ใช้แป้นพิมพ์ปกติ</>}
                                            </button>
                                        </div>

                                        {sections.map(sec => (
                                            <div key={sec.id} className="bg-white p-5 rounded-xl border shadow-sm">
                                                <h4 className="font-bold text-primary-700 mb-4 font-display flex items-center gap-2 border-b pb-2"><div className="w-1.5 h-6 bg-primary-600 rounded-full"></div> {sec.title}</h4>
                                                {sec.groups?.map(g => (
                                                    <div key={g.id} className="mb-6 last:mb-0">
                                                        <div className="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">{g.title}</div>
                                                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                                            {g.columns?.map(c => {
                                                                const isAuto = c.type !== 'manual';
                                                                const displayVal = isAuto ? calculateColumnValue(scoreModalData, g, c) : (scoreModalData.scores?.[c.id] || '');
                                                                const isActive = numpadState.isOpen && numpadState.colId === c.id;
                                                                
                                                                return (
                                                                    <div key={c.id} className="relative">
                                                                        <div className="flex justify-between text-xs mb-1 font-medium text-gray-500">
                                                                            <span>{c.name}</span>
                                                                            <span>{isAuto ? 'Auto' : `/${c.max}`}</span>
                                                                        </div>
                                                                        <input 
                                                                            type={useNumpad ? "text" : "number"}
                                                                            readOnly={useNumpad || isAuto}
                                                                            autoFocus={!useNumpad && c.type === 'manual' && !scoreModalData.scores?.[c.id]} 
                                                                            className={`score-input w-full p-3 border-2 rounded-xl text-center font-bold text-xl outline-none transition shadow-sm ${
                                                                                isAuto 
                                                                                    ? 'bg-gray-50 text-gray-400 border-transparent' 
                                                                                    : isActive && useNumpad
                                                                                        ? 'bg-primary-50 border-primary-500 text-primary-700 ring-4 ring-primary-100' 
                                                                                        : 'bg-white border-gray-200 text-slate-700 hover:border-primary-300 focus:border-primary-500 focus:ring-4 focus:ring-primary-50'
                                                                            }`}
                                                                            value={displayVal}
                                                                            onClick={() => {
                                                                                if(useNumpad && !isAuto) {
                                                                                     setNumpadState({ isOpen: true, colId: c.id, max: c.max, name: c.name });
                                                                                }
                                                                            }}
                                                                            onChange={e => {
                                                                                if(!useNumpad && !isAuto) {
                                                                                    const val = parseFloat(e.target.value);
                                                                                    if (!isNaN(val) && val > c.max) {
                                                                                        setWarning({show:true, msg:`คะแนนเต็มคือ ${c.max} ครับ`});
                                                                                        return; 
                                                                                    }
                                                                                    setScoreModalData({...scoreModalData, scores: {...scoreModalData.scores, [c.id]: e.target.value}});
                                                                                }
                                                                            }}
                                                                            onKeyDown={e => {
                                                                                if(!useNumpad) {
                                                                                    if (['Enter', 'ArrowDown', 'ArrowRight'].includes(e.key)) {
                                                                                        e.preventDefault();
                                                                                        const inputs = Array.from(document.querySelectorAll('.score-input:not([disabled])'));
                                                                                        const index = inputs.indexOf(e.target);
                                                                                        if (index < inputs.length - 1) {
                                                                                            inputs[index + 1].focus();
                                                                                            inputs[index + 1].select();
                                                                                        } else {
                                                                                            document.getElementById('save-btn').click();
                                                                                        }
                                                                                    } else if (['ArrowUp', 'ArrowLeft'].includes(e.key)) {
                                                                                        e.preventDefault();
                                                                                        const inputs = Array.from(document.querySelectorAll('.score-input:not([disabled])'));
                                                                                        const index = inputs.indexOf(e.target);
                                                                                        if (index > 0) {
                                                                                            inputs[index - 1].focus();
                                                                                            inputs[index - 1].select();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }}
                                                                        />
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-4 border-t bg-white flex justify-between items-center gap-4">
                                        <div className="flex gap-2">
                                            <button onClick={() => navigateStudent(-1)} className="p-3 rounded-xl bg-gray-100 text-gray-600 hover:bg-gray-200 font-bold"><Icons.ChevronLeft/></button>
                                            <button onClick={() => navigateStudent(1)} className="p-3 rounded-xl bg-gray-100 text-gray-600 hover:bg-gray-200 font-bold"><Icons.ChevronRight/></button>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => { setScoreModalData(null); setNumpadState({isOpen:false}); if(returnToScanner) { setReturnToScanner(false); setIsScannerOpen(true); } }} className="px-6 py-3 rounded-xl text-gray-500 hover:bg-gray-50 font-bold transition">ปิด</button>
                                            <button id="save-btn" onClick={async () => {
                                                await updateStudent(scoreModalData);
                                                // Animation feedback
                                                const btn = document.getElementById('save-btn');
                                                const originalText = btn.innerHTML;
                                                btn.innerHTML = '✅ บันทึกแล้ว';
                                                btn.classList.add('bg-success-600');
                                                setTimeout(() => {
                                                    btn.innerHTML = originalText;
                                                    btn.classList.remove('bg-success-600');
                                                    
                                                    // Logic: Save and Close immediately
                                                    setScoreModalData(null);
                                                    setNumpadState({isOpen:false});
                                                    if(returnToScanner) {
                                                        setReturnToScanner(false);
                                                        setIsScannerOpen(true);
                                                    }
                                                }, 500);
                                            }} className="px-8 py-3 rounded-xl bg-primary-600 text-white font-bold shadow-lg hover:bg-primary-700 flex items-center gap-2 transition-all">
                                                {returnToScanner ? 'บันทึก & สแกนต่อ' : 'บันทึกและปิด'}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Virtual Numpad Overlay */}
                                    <VirtualNumpad 
                                        isOpen={numpadState.isOpen && useNumpad} 
                                        target={numpadState} 
                                        onInput={handleNumpadInput} 
                                        onClose={() => setNumpadState({ ...numpadState, isOpen: false })}
                                        onConfirm={() => setNumpadState({ ...numpadState, isOpen: false })}
                                    />
                                </div>
                            </div>
                        )}

                        {studentModalData && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 animate-slide-up">
                                    <h3 className="font-bold text-lg mb-4 text-gray-800 border-b pb-2">แก้ไขข้อมูลนักเรียน</h3>
                                    <div className="space-y-4">
                                        <div><label className="text-xs font-bold text-gray-500 uppercase">เลขที่</label><input className="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white transition" value={studentModalData.no} onChange={e => setStudentModalData({...studentModalData, no: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-gray-500 uppercase">รหัส (แก้ไม่ได้)</label><input disabled className="w-full p-2 border rounded-lg bg-gray-200 text-gray-500 cursor-not-allowed" value={studentModalData.id} /></div>
                                        <div><label className="text-xs font-bold text-gray-500 uppercase">ชื่อ-นามสกุล</label><input className="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white transition" value={studentModalData.name} onChange={e => setStudentModalData({...studentModalData, name: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-gray-500 uppercase">ห้อง</label><input className="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white transition" value={studentModalData.room} onChange={e => setStudentModalData({...studentModalData, room: e.target.value})} /></div>
                                    </div>
                                    <div className="mt-6 flex justify-end gap-2">
                                        <button onClick={() => setStudentModalData(null)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition">ยกเลิก</button>
                                        <button onClick={async () => { await updateStudent(studentModalData); setStudentModalData(null); }} className="px-6 py-2 bg-primary-600 text-white rounded-lg font-bold hover:bg-primary-700 shadow transition">บันทึก</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isAddStudentOpen && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
                                    <h3 className="font-bold text-lg mb-4 text-primary-700 flex items-center gap-2"><Icons.UserPlus/> เพิ่มนักเรียนใหม่</h3>
                                    <input className="w-full p-3 border rounded-xl mb-3 bg-gray-50 focus:bg-white transition" placeholder="รหัสประจำตัว (Key)" value={newStudent.id} onChange={e => setNewStudent({...newStudent, id: e.target.value})} />
                                    <input className="w-full p-3 border rounded-xl mb-3 bg-gray-50 focus:bg-white transition" placeholder="ชื่อ-นามสกุล" value={newStudent.name} onChange={e => setNewStudent({...newStudent, name: e.target.value})} />
                                    <div className="flex gap-3 mb-4">
                                        <input className="flex-1 p-3 border rounded-xl bg-gray-50 focus:bg-white transition" placeholder="ห้อง (1/1)" value={newStudent.room} onChange={e => setNewStudent({...newStudent, room: e.target.value})} />
                                        <input className="w-24 p-3 border rounded-xl bg-gray-50 focus:bg-white transition" placeholder="เลขที่" value={newStudent.no} onChange={e => setNewStudent({...newStudent, no: e.target.value})} />
                                    </div>
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setIsAddStudentOpen(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition">ยกเลิก</button>
                                        <button onClick={async () => { if(!newStudent.id) return alert('ใส่รหัสด้วยครับ'); await updateStudent({...newStudent, scores: {}}); setIsAddStudentOpen(false); setNewStudent({id:'', name:'', room:'', no:''}); }} className="px-6 py-2 bg-primary-600 text-white rounded-xl font-bold shadow hover:bg-primary-700 transition">บันทึก</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isScannerOpen && (
                            <div className="fixed inset-0 bg-black flex flex-col items-center justify-center z-[100]">
                                <div className="absolute top-4 right-4 z-50"><button onClick={() => setIsScannerOpen(false)} className="bg-white/20 p-2 rounded-full text-white hover:bg-white/40"><Icons.X size={32}/></button></div>
                                <h3 className="text-white text-2xl font-bold mb-8 flex gap-3 animate-slide-up"><Icons.Camera size={32}/> ส่องบาร์โค้ดเลยครับ</h3>
                                <div className="w-full max-w-sm aspect-square bg-black rounded-3xl overflow-hidden border-4 border-primary-500 relative shadow-2xl">
                                    <ScannerController isOpen={isScannerOpen} onScan={handleTeacherSearch} />
                                    <div className="absolute inset-0 border-2 border-white/30 rounded-2xl m-8 pointer-events-none animate-pulse"></div>
                                </div>
                                <p className="text-gray-400 mt-8 text-center px-4">ระบบจะเด้งหน้าต่างกรอกคะแนนขึ้นมา<br/>ทันทีที่สแกนติด</p>
                            </div>
                        )}

                        {isImportOpen && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6">
                                    <h3 className="font-bold text-lg mb-2">นำเข้าข้อมูล (Excel Copy-Paste)</h3>
                                    <p className="text-xs text-gray-500 mb-4 bg-warning-50 p-2 rounded border border-warning-100">รูปแบบ: รหัส [tab] ชื่อ [tab] ห้อง [tab] เลขที่</p>
                                    {isImporting ? (
                                        <div className="w-full h-48 flex flex-col items-center justify-center bg-gray-50 rounded-xl border border-gray-200">
                                            <div className="w-64 bg-gray-200 rounded-full h-4 mb-2 overflow-hidden"><div className="bg-primary-600 h-4 rounded-full transition-all duration-300 ease-out" style={{width: `${importProgress}%`}}></div></div>
                                            <div className="text-gray-500 font-bold">{importProgress}%</div>
                                            <div className="text-xs text-gray-400 mt-1">กำลังนำเข้าข้อมูล...</div>
                                        </div>
                                    ) : (
                                        <textarea className="w-full h-48 p-3 border rounded-xl text-sm font-mono bg-gray-50 focus:bg-white transition outline-none focus:border-primary-500" placeholder="66001  สมชาย  1/1  1..." value={importText} onChange={e => setImportText(e.target.value)}></textarea>
                                    )}
                                    <div className="flex justify-end gap-2 mt-4">
                                        <button onClick={() => setIsImportOpen(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" disabled={isImporting}>ปิด</button>
                                        <button onClick={handleBulkImport} className="px-6 py-2 bg-primary-600 text-white rounded-xl font-bold shadow hover:bg-primary-700 transition" disabled={isImporting}>{isImporting ? 'กำลังทำงาน...' : `นำเข้า ${importText.split('\n').filter(l=>l.trim()).length} คน`}</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {warning.show && (
                            <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-danger-600 text-white px-6 py-3 rounded-full shadow-2xl z-[200] animate-slide-up flex items-center gap-3 cursor-pointer hover:bg-danger-700 transition" onClick={() => setWarning({show:false, msg:''})}>
                                <Icons.AlertTriangle/> <span className="font-bold">{warning.msg}</span>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
